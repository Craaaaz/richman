# 玩家順序同步修復測試指南

## 修復內容總結

### 1. 問題分析
- **根本問題**：玩家順序同步不完整，主機玩家順序從未同步給客戶端
- **導致後果**：客戶端玩家列表不完整，回合切換邏輯失敗

### 2. 實施的修復方案（方案一）

#### 2.1 批量同步機制
- **新增 `sync_all_player_orders()` RPC 函數**：批量同步所有玩家順序
- **修改 `_on_player_connected()`**：新玩家連接時，同步所有現有玩家順序給該玩家

#### 2.2 增強除錯和容錯
- **增強 `_next_player_turn()`**：添加詳細除錯資訊和容錯邏輯
- **增強 `_initialize_players()`**：添加狀態檢查和備用方案
- **增強 `sync_player_turn()`**：添加玩家存在性檢查

#### 2.3 修復邏輯錯誤
- **修復 `get_players_in_order()`**：正確處理玩家順序範圍
- **修復計數器更新邏輯**：確保 `player_order_counter` 正確更新

## 測試步驟

### 測試1：基本功能測試
1. **啟動主機（玩家一）**
   - 檢查控制台輸出：主機玩家順序應為1
   - 檢查狀態顯示：應顯示「玩家一 已連線」

2. **連接第一個客戶端（玩家二）**
   - 檢查控制台輸出：應看到「批量同步所有玩家順序」
   - 檢查客戶端：應收到主機玩家（ID 1）和自身（ID 2）的順序
   - 檢查狀態顯示：應顯示「玩家二 已連線」

3. **連接第二個客戶端（玩家三）**
   - 檢查控制台輸出：應看到批量同步三個玩家的順序
   - 檢查所有客戶端：玩家順序應一致（1→玩家一，2→玩家二，3→玩家三）

### 測試2：遊戲初始化測試
1. **所有玩家連接後開始遊戲**
   - 檢查遊戲場景初始化：`_initialize_players()` 應正確列出所有玩家
   - 檢查玩家顯示：應顯示中文名稱而非玩家ID
   - 檢查第一回合：應正確分配給「玩家一」

### 測試3：回合切換測試
1. **玩家一擲骰子並移動**
   - 檢查回合切換：移動完成後應切換到「玩家二」
   - 檢查按鈕文字：應顯示「等待玩家二」

2. **玩家二擲骰子並移動**
   - 檢查回合切換：應切換到「玩家三」
   - 檢查所有客戶端：回合狀態應同步

3. **玩家三擲骰子並移動**
   - 檢查回合切換：應循環回到「玩家一」

### 測試4：玩家斷線測試
1. **玩家二斷線**
   - 檢查順序重整：玩家三應變為「玩家二」
   - 檢查回合邏輯：如果斷線玩家是當前回合，應正確切換到下一個玩家

### 測試5：錯誤恢復測試
1. **模擬同步失敗**
   - 檢查容錯邏輯：當玩家不在列表中時應使用備用方案
   - 檢查除錯輸出：應提供足夠的資訊診斷問題

## 預期輸出示例

### 連接過程
```
# 主機啟動
玩家已加入資訊庫：玩家一 (ID: 1, 順序: 1)

# 玩家二連接
同步玩家順序：ID 2 -> 順序 2
向新玩家 2 同步所有玩家順序：{1: 1, 2: 2}
批量同步所有玩家順序：{1: 1, 2: 2}
所有玩家順序批量同步完成，共 2 名玩家
  - 玩家一 (ID: 1, 順序: 1)
  - 玩家二 (ID: 2, 順序: 2)

# 玩家三連接
同步玩家順序：ID 3 -> 順序 3
向新玩家 3 同步所有玩家順序：{1: 1, 2: 2, 3: 3}
批量同步所有玩家順序：{1: 1, 2: 2, 3: 3}
所有玩家順序批量同步完成，共 3 名玩家
  - 玩家一 (ID: 1, 順序: 1)
  - 玩家二 (ID: 2, 順序: 2)
  - 玩家三 (ID: 3, 順序: 3)
```

### 遊戲初始化
```
=== 所有玩家已就緒，開始初始化 ===
伺服器玩家順序狀態檢查：
  player_id_to_order: {1: 1, 2: 2, 3: 3}
  player_order_to_id: {1: 1, 2: 2, 3: 3}
所有玩家（按順序）: [1, 2, 3]
  - 玩家一 (ID: 1)
  - 玩家二 (ID: 2)
  - 玩家三 (ID: 3)
=== 初始化完成，第一回合: 玩家一 ===
```

### 回合切換
```
=== 回合切換除錯資訊 ===
當前玩家ID: 1 (玩家一)
玩家列表: [1, 2, 3]
  - 玩家一 (ID: 1)
  - 玩家二 (ID: 2)
  - 玩家三 (ID: 3)
切換回合，現在是玩家二的回合
=== 回合切換完成 ===
```

## 常見問題排查

### 問題1：玩家順序不一致
**症狀**：不同客戶端顯示不同的玩家名稱
**解決**：檢查 `sync_all_player_orders` 的日誌輸出

### 問題2：回合不切換
**症狀**：一直停留在同一個玩家的回合
**解決**：檢查 `_next_player_turn` 的除錯輸出，驗證玩家列表

### 問題3：玩家顯示為ID而非名稱
**症狀**：玩家標籤顯示數字而非「玩家一」等
**解決**：檢查 `_create_player` 函數是否使用 `global.get_player_name_by_id()`

## 修復驗證要點

1. ✅ **同步完整性**：所有客戶端有相同的玩家順序映射
2. ✅ **名稱顯示**：所有玩家顯示中文名稱而非ID
3. ✅ **回合切換**：回合按順序正確切換
4. ✅ **容錯能力**：異常情況下有合理的恢復機制
5. ✅ **除錯資訊**：足夠的日誌幫助診斷問題

## 後續優化建議

1. **性能優化**：減少不必要的同步，只在必要時同步
2. **狀態驗證**：添加玩家狀態一致性檢查
3. **重連處理**：完善玩家斷線重連的順序處理
4. **UI反饋**：在UI中顯示更詳細的同步狀態