# Godot 多人連線大富翁 (Multiplayer Monopoly)

這是一個使用 Godot 4.6+ (Forward Plus) 開發的網格基礎多人連線大富翁遊戲。專案使用 ENet 進行網路同步，並包含地圖編輯器與基礎的經濟系統。

## 📅 更新日誌 (Changelog)

### [2026-02-10] 核心功能優化與系統擴充

**1. 地塊屬性與經濟系統 (Tile Properties & Economy)**
*   **新增**: 在 `Player.gd` 中加入資金變數 (`money`)，初始資金為 $15,000。
*   **新增**: 在 `Venue_configuration.gd` 與 `Site.gd` 中定義並實作多種地塊類型：
    *   `1` (白): 普通道路 (無效果)
    *   `2` (黃): 起點 (經過/停留獲得 $2000)
    *   `3` (藍): 地產 (停留扣除 $1000，模擬購買)
    *   `4` (粉): 商店 (暫無功能)
*   **新增**: `GameUI.gd` 左下角顯示當前玩家資金。
*   **實作**: 在 `Lobby.gd` 的 `_handle_tile_event` 中處理移動結束後的事件邏輯（加錢/扣錢），並透過 RPC 同步至所有客戶端。

**2. 地圖編輯器修復 (Map Editor Visuals)**
*   **修改**: `MapEditor.gd` 現在嚴格顯示為「黑白」二色。
    *   **白**: 所有非空地塊 (類型 ID > 0)。
    *   **黑**: 空地 (類型 ID = 0)。
*   **修復**: 修正了編輯器 UI 佈局。原先按鈕區因絕對定位與固定視窗大小衝突而被遮蔽，現改為彈性 `VBoxContainer` 佈局，確保「儲存/取消」按鈕永遠可見。

**3. 穩定性與 UX 修復 (Stability & UX)**
*   **修復**: `Lobby.gd` 中建立主機 (`create_server`) 時的崩潰問題。加入了 `peer.host` 的空值檢查與埠口佔用 (Error 22) 的錯誤捕捉提示。
*   **修復**: 方向選擇器 (`DirectionSelector.gd`) 的位置錯位問題。將計算方式由 `position` (局部座標) 改為 `global_position` (全域座標)，確保 UI 能正確跟隨位於縮放地圖中的玩家，並強制顯示在最上層 (`z_index`)。

---

## 🎮 當前功能與實作細節

### 1. 網路連線系統
*   **功能**: 支援 Host (主機) 與 Join (加入) 的大廳系統。
*   **實作檔案**: `Lobby.gd`
*   **關鍵環節**:
    *   `_on_host_pressed()`: 使用 `ENetMultiplayerPeer.create_server()` 建立主機。
    *   `_on_join_pressed()`: 使用 `ENetMultiplayerPeer.create_client()` 連線。
    *   `spawn_players()`: 主機計算出生點後，透過 RPC 通知所有客戶端生成玩家實體。

### 2. 地圖系統
*   **功能**: 基於矩陣 (Matrix) 生成視覺化網格地圖，支援自動縮放適配螢幕。
*   **實作檔案**: `Site.gd`, `Venue_configuration.gd`
*   **關鍵環節**:
    *   `generate_map()`: 讀取矩陣數據，根據數值 (0-4) 實例化對應顏色的 `Panel`。
    *   `_fit_map_to_screen()`: 計算地圖邊界並調整 `Scale` 與 `Position` 以適應視窗。
    *   `get_valid_neighbors()`: 用於移動邏輯，判斷上下左右是否有路。

### 3. 移動與回合機制
*   **功能**: 回合制擲骰移動，支援自動尋路與叉路選擇。
*   **實作檔案**: `Lobby.gd` (邏輯核心), `Player.gd` (視覺移動)
*   **關鍵環節**:
    *   `_process_next_movement_step()`: 遞迴執行的移動邏輯。
    *   **叉路偵測**: 當偵測到多個可行方向時，暫停移動並呼叫 `_ask_player_direction`。
    *   **死路處理**: 若無路可走，自動彈回上一步。

### 4. 互動 UI (HUD)
*   **功能**: 顯示回合資訊、擲骰按鈕、擲骰結果動畫、玩家資金。
*   **實作檔案**: `GameUI.gd`, `DirectionSelector.gd`
*   **關鍵環節**:
    *   `update_turn_info()`: 顯示當前輪到誰。
    *   `show_direction_selector()`: 在玩家頭上顯示方向箭頭 (已修正座標系問題)。

### 5. 地圖編輯器
*   **功能**: 視覺化修改地圖路徑 (20x20 網格)。
*   **實作檔案**: `MapEditor.gd`
*   **關鍵環節**:
    *   點擊格子切換 0 (黑/空) 與 1 (白/路)。
    *   儲存後會透過訊號將矩陣傳回 `Lobby.gd` 並覆蓋預設地圖。

---

## 🚀 未來規劃 (Roadmap)

### 1. 完整地產所有權系統 (Property Ownership)
目前地產僅是單純的「扣錢格」。下一步將實作：
*   **購買機制**: 走到無主地可選擇購買。
*   **過路費機制**: 走到他人地盤需支付過路費。
*   **地主標示**: 在地圖格上顯示持有者的顏色或標記。

### 2. 進階地圖編輯器 (Advanced Editor)
目前的編輯器僅支援「路」與「空」。下一步將實作：
*   **多類型繪製**: UI 增加工具列，可選擇繪製「起點」、「地產」、「商店」等特殊格子。
*   **即時預覽**: 編輯器內的格子顏色應與遊戲內 (`Site.gd`) 的定義一致。

### 3. 遊戲結束與結算 (Game Over & Ranking)
目前遊戲無限進行。下一步將實作：
*   **破產判定**: 當資金 < 0 時，判定玩家淘汰。
*   **勝利條件**: 當剩餘最後一名玩家時，顯示勝利畫面並結束遊戲。
